name: CyberLynx OS - XFCE Master Build

on:
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›°ï¸ KaynaklarÄ± Ã‡ek
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Gerekli AraÃ§larÄ± Kur
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc bison flex libssl-dev libelf-dev \
          qemu-utils xorriso grub-pc-bin grub-common mtools squashfs-tools wget cpio

      - name: ğŸ§  Kernel 6.6 Derle
        run: |
          wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.10.tar.xz
          tar -xf linux-6.6.10.tar.xz && cd linux-6.6.10
          make defconfig
          scripts/config --set-str CONFIG_LOCALVERSION "-CyberLynx"
          scripts/config --enable CONFIG_FB_EFI
          scripts/config --enable CONFIG_DRM_FBDEV_EMULATION
          make -j$(nproc) bzImage
          cd ..
          mkdir -p iso_root/boot/grub
          cp linux-6.6.10/arch/x86/boot/bzImage iso_root/boot/vmlinuz-cyberlynx

      - name: ğŸ—ï¸ Rootfs ve KlasÃ¶r YapÄ±sÄ±nÄ± OluÅŸtur (Hata Giderildi)
        run: |
          # TÃœM KLASÃ–RLERÄ° Ã–NCE OLUÅTURUYORUZ (HatanÄ±n Ã§Ã¶zÃ¼mÃ¼ burada)
          mkdir -p rootfs/{bin,sbin,etc/init.d,usr/bin,usr/sbin,proc,sys,dev,tmp,var/lib/pacman}
          
          # Busybox'Ä± Ã§ekirdek komutlar iÃ§in ekle
          sudo apt-get install -y busybox-static
          cp /bin/busybox rootfs/bin/
          cd rootfs/bin && ./busybox --install -s . && cd ../../

      - name: ğŸ–¥ï¸ XFCE GUI ve Cyber-Config YapÄ±landÄ±rmasÄ±
        run: |
          # XFCE BaÅŸlatÄ±cÄ± Script
          cat <<EOF > rootfs/usr/bin/start-xfce-custom
          #!/bin/sh
          X &
          export DISPLAY=:0
          exec startxfce4
          EOF
          chmod +x rootfs/usr/bin/start-xfce-custom

          # BlackArch Repo Ekleme (Cyber-Repo adÄ±yla)
          cat <<EOF > rootfs/etc/pacman.conf
          [options]
          HoldPkg = pacman glibc
          Architecture = auto
          SigLevel = Never
          [cyberlynx-core]
          Server = https://mirror.rackspace.com/blackarch/\$repo/os/\$arch
          EOF

      - name: âš™ï¸ OS BaÅŸlatÄ±cÄ± (init.d/rcS) YazÄ±mÄ±
        run: |
          # ARTIK BU DOSYA HATA VERMEYECEK Ã‡ÃœNKÃœ KLASÃ–RÃœ YUKARIDA AÃ‡TIK
          cat <<EOF > rootfs/etc/init.d/rcS
          #!/bin/sh
          mount -t proc none /proc
          mount -t sysfs none /sys
          /sbin/mdev -s
          echo "CyberLynx XFCE GUI Baslatiliyor..."
          /usr/bin/start-xfce-custom
          EOF
          chmod +x rootfs/etc/init.d/rcS

      - name: ğŸ–¼ï¸ Boot Splash (VaÅŸak Logosu)
        run: |
          wget -O iso_root/boot/grub/splash.png "https://raw.githubusercontent.com/iifii4583-coder/Awk/refs/heads/main/1768655851489.png"

      - name: ğŸ’¿ ISO Paketleme
        run: |
          cd rootfs && find . | cpio -H newc -o | gzip > ../iso_root/boot/initrd-cyberlynx.img && cd ..
          
          cat <<EOF > iso_root/boot/grub/grub.cfg
          insmod png
          set timeout=2
          background_image /boot/grub/splash.png
          menuentry "CyberLynx OS (XFCE GUI)" {
              linux /boot/vmlinuz-cyberlynx quiet splash
              initrd /boot/initrd-cyberlynx.img
          }
          EOF
          
          grub-mkrescue -o CyberLynx-XFCE-Ultimate.iso iso_root

      - name: ğŸ“¦ ISO YayÄ±nla
        uses: actions/upload-artifact@v4
        with:
          name: CyberLynx-XFCE-ISO
          path: CyberLynx-XFCE-Ultimate.iso
          
