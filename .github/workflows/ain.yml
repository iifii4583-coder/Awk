name: CyberLynx OS - Full XFCE (Correct Size)

on:
  workflow_dispatch:

jobs:
  build-full-iso:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›°ï¸ KaynaklarÄ± Ã‡ek
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ OS Ä°nÅŸa AraÃ§larÄ±nÄ± Kur
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc bison flex libssl-dev libelf-dev \
          qemu-utils xorriso grub-pc-bin grub-common mtools squashfs-tools wget cpio arch-install-scripts

      - name: ğŸ§  Cyber-Kernel 6.6.10 Derle
        run: |
          wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.10.tar.xz
          tar -xf linux-6.6.10.tar.xz && cd linux-6.6.10
          make defconfig
          scripts/config --set-str CONFIG_LOCALVERSION "-CyberLynx"
          scripts/config --enable CONFIG_FB_EFI
          scripts/config --enable CONFIG_DRM_FBDEV_EMULATION
          make -j$(nproc) bzImage
          cd ..
          mkdir -p iso_root/boot/grub
          cp linux-6.6.10/arch/x86/boot/bzImage iso_root/boot/vmlinuz-cyberlynx

      - name: ğŸ—ï¸ GerÃ§ek Rootfs Ä°nÅŸasÄ± (XFCE Dahil)
        run: |
          mkdir -p rootfs
          # Temel sistem ve XFCE paketlerini indiriyoruz (Boyut burada artacak)
          sudo debootstrap --include=xfce4,xserver-xorg,xfce4-terminal,network-manager,lightdm,sudo,python3-tk stable rootfs http://deb.debian.org/debian/

      - name: ğŸ¨ CyberLynx Ã–zelleÅŸtirme
        run: |
          # KlasÃ¶rleri ve baÅŸlatÄ±cÄ±larÄ± hazÄ±rla
          sudo mkdir -p rootfs/etc/init.d
          sudo bash -c "cat <<EOF > rootfs/etc/init.d/rcS
          #!/bin/sh
          mount -t proc none /proc
          mount -t sysfs none /sys
          /sbin/mdev -s
          exec startxfce4
          EOF"
          sudo chmod +x rootfs/etc/init.d/rcS

          # BlackArch Repo Ekleme
          sudo bash -c "echo 'deb [trusted=yes] https://mirror.rackspace.com/blackarch/blackarch/os/x86_64/ /' > rootfs/etc/apt/sources.list.d/cyber.list"

      - name: ğŸ–¼ï¸ Boot Splash
        run: |
          wget -O iso_root/boot/grub/splash.png "https://raw.githubusercontent.com/iifii4583-coder/Awk/refs/heads/main/1768655851489.png"

      - name: ğŸ’¿ ISO Paketleme (SquashFS ile)
        run: |
          # Sistemi sÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ dosya sistemi haline getir (GerÃ§ek OS mantÄ±ÄŸÄ±)
          sudo mksquashfs rootfs iso_root/live.squashfs -comp xz
          
          # Initrd oluÅŸtur
          cd rootfs && find . -maxdepth 1 -not -path '*/.*' | cpio -H newc -o | gzip > ../iso_root/boot/initrd.img && cd ..

          cat <<EOF > iso_root/boot/grub/grub.cfg
          insmod png
          set timeout=2
          background_image /boot/grub/splash.png
          menuentry "CyberLynx OS Full (XFCE)" {
              linux /boot/vmlinuz-cyberlynx boot=live quiet splash
              initrd /boot/initrd.img
          }
          EOF

          grub-mkrescue -o CyberLynx-Full.iso iso_root

      - name: ğŸ“¦ ISO YayÄ±nla
        uses: actions/upload-artifact@v4
        with:
          name: CyberLynx-Full-ISO
          path: CyberLynx-Full.iso
          
