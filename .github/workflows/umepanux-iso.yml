name: Umepanux ISO Builder

on:
  workflow_dispatch: # Manuel olarak başlatmak için

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y debootstrap squashfs-tools xorriso grub-pc-bin grub-efi-amd64-bin mtools libncurses-dev flex bison bc libelf-dev libssl-dev gcc make

      - name: Build Linux Kernel
        run: |
          KERNEL_VER=6.1.0
          wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-$KERNEL_VER.tar.xz
          tar -xf linux-$KERNEL_VER.tar.xz
          cd linux-$KERNEL_VER
          make defconfig
          # Hızlı derleme için modülleri ve gereksizleri minimize edebilirsiniz
          make -j$(nproc) bzImage
          cp arch/x86/boot/bzImage ../vmlinuz
          cd ..

      - name: Create Debian Rootfs (No Password)
        run: |
          sudo debootstrap --arch=amd64 bullseye ./rootfs http://deb.debian.org/debian/
          
          # Otomatik giriş (No password login) yapılandırması
          sudo chroot ./rootfs /bin/bash -c "
            echo 'umepanux' > /etc/hostname
            echo 'root:root' | chpasswd
            # Getty override ile şifresiz giriş
            mkdir -p /etc/systemd/system/getty@tty1.service.d
            echo -e '[Service]\nExecStart=\nExecStart=-/sbin/agetty --autologin root --noclear %I \$TERM' > /etc/systemd/system/getty@tty1.service.d/override.conf
          "
          
          # Rootfs'i sıkıştır
          sudo mksquashfs ./rootfs filesystem.squashfs -comp xz

      - name: Create ISO Structure
        run: |
          mkdir -p iso_root/boot/grub
          cp vmlinuz iso_root/boot/vmlinuz
          cp filesystem.squashfs iso_root/boot/filesystem.squashfs
          
          # Grub Menüsü Oluşturma
          cat <<EOF > iso_root/boot/grub/grub.cfg
          set default=0
          set timeout=1
          menuentry "Umepanux Linux" {
              linux /boot/vmlinuz boot=live quiet
              initrd /boot/initrd.img # Varsa
          }
          EOF

      - name: Generate ISO
        run: |
          grub-mkrescue -o umepanux.iso iso_root

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: umepanux-iso
          path: umepanux.iso
          
